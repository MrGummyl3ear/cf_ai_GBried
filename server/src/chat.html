<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style type="text/css">
* {
  box-sizing: border-box;
}
body {
  font-family: Arial, Helvetica, sans-serif;
}

#chatlog {
  position: fixed;
  top: 0;
  bottom: 32px;
  left: 0;
  right: 200px;
  overflow-y: auto;
  padding: 8px;
  overflow-wrap: break-word;
}

#chatlog span.username {
  font-weight: bold;
}

#spacer {
  height: calc(100vh - 32px - 5em);
}

#roster {
  font-weight: bold;
  padding: 8px;
}

p {
  margin-top: 0;
  margin-bottom: 8px;
}

p:last-of-type {
  margin: 0;
}

#roster {
  position: fixed;
  right: 0;
  top: 0;
  bottom: 32px;
  width: 200px;
  border-left: none;
}

::-webkit-scrollbar {
  display: none;
}

@media(max-width:600px) {
  #roster { display: none; }
  #chatlog { right: 0; }
}

#chat-input {
  position: fixed;
  width: 100%;
  height: 32px;
  bottom: 0;
  left: 0;
  border: none;
  border-top: none;
  padding-left: 32px;
  outline: none;
}

#chatroom::before {
  z-index: 1;
  display: block;
  content: ">";
  position: fixed;
  bottom: 0;
  left: 0;
  width: 32px;
  height: 32px;
  line-height: 32px;
  text-align: center;
  font-weight: bold;
  color: #888;
  -webkit-text-stroke-width: 2px;
}

#name-form {
  position: fixed;
  z-index: 3;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: white;
}

#name-input {
  position: fixed;
  font-size: 200%;
  top: calc(50% - 1em);
  left: calc(50% - 8em);
  width: 16em;
  height: 2em;
  margin: 0;
  text-align: center;
  border: 1px solid #bbb;
}

#name-form p {
  position: fixed;
  top: calc(50% + 3em);
  width: 100%;
  text-align: center;
}

#room-form {
  position: fixed;
  z-index: 2;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: white;
  font-size: 200%;
  margin-top: calc(50vh - 3em);
  text-align: center;
}

#room-name {
  font-size: inherit;
  border: 1px solid #bbb;
  height: 2em;
  width: 16em;
  padding-left: 1em;
}

#room-form button {
  font-size: inherit;
  border: 1px solid #bbb;
  background-color: #eee;
  height: 2em;
}

@media(max-width:660px) {
  #name-input, #room-form { font-size: 150%; }
  #name-form p { font-size: 75%; }
}

@media(max-width:500px) {
  #name-input, #room-form { font-size: 100%; }
  #name-form p { font-size: 50%; }
}

#go-public { width: 4em; }
#go-private { width: 20em; }

/* ðŸ”¹ AI Summarize button */
#summarize-btn {
  position: fixed;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  padding: 6px 14px;
  font-size: 14px;
  border: 1px solid #bbb;
  background: #f4f4f4;
  cursor: pointer;
  display: none;
}

#summarize-btn:hover {
  background: #eaeaea;
}
</style>
  </head>

  <body>

    <form id="room-form" action="/fake-form-action">
      <p>Enter a public room:</p>
      <input id="room-name" placeholder="room name">
      <button id="go-public">Go &raquo;</button>
      <p>OR</p>
      <button id="go-private">Create a Private Room &raquo;</button>
    </form>

    <form id="chatroom" action="/fake-form-action">
      <button id="summarize-btn" type="button">Summarize with AI</button>

      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      <div id="roster"></div>
      <input id="chat-input">
    </form>
  </body>

<script type="text/javascript">
let currentWebSocket = null;

let nameForm = document.querySelector("#name-form");
let nameInput = document.querySelector("#name-input");
let roomForm = document.querySelector("#room-form");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatroom = document.querySelector("#chatroom");
let chatlog = document.querySelector("#chatlog");
let chatInput = document.querySelector("#chat-input");
let roster = document.querySelector("#roster");
let summarizeBtn = document.querySelector("#summarize-btn");

let isAtBottom = true;
let username;
let roomname;

let hostname = window.location.host;
if (hostname == "") {
  hostname = "edge-chat-demo.cloudflareworkers.com";
}

function startNameChooser() {
  nameForm.addEventListener("submit", event => {
    event.preventDefault();
    username = nameInput.value;
    if (username.length > 0) {
      startRoomChooser();
    }
  });

  nameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value =
        event.currentTarget.value.slice(0, 32);
    }
  });

  nameInput.focus();
}

function startRoomChooser() {
  nameForm.remove();

  if (document.location.hash.length > 1) {
    roomname = document.location.hash.slice(1);
    startChat();
    return;
  }

  roomForm.addEventListener("submit", event => {
    event.preventDefault();
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      startChat();
    }
  });

  goPublicButton.addEventListener("click", () => {
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      startChat();
    }
  });

  goPrivateButton.addEventListener("click", async event => {
    roomNameInput.disabled = true;
    goPublicButton.disabled = true;
    event.currentTarget.disabled = true;

    let response = await fetch(
      "https://" + hostname + "/api/room",
      { method: "POST" }
    );

    roomname = await response.text();
    startChat();
  });

  roomNameInput.focus();
}

function startChat() {
  roomForm.remove();
  summarizeBtn.style.display = "block";

  roomname = roomname
    .replace(/[^a-zA-Z0-9_-]/g, "")
    .replace(/_/g, "-")
    .toLowerCase();

  document.location.hash = "#" + roomname;

  chatroom.addEventListener("submit", event => {
    event.preventDefault();
    if (currentWebSocket) {
      currentWebSocket.send(
        JSON.stringify({ message: chatInput.value })
      );
      chatInput.value = "";
      chatlog.scrollBy(0, 1e8);
    }
  });

  summarizeBtn.addEventListener("click", () => {
    let messages = [];
    chatlog.querySelectorAll("p").forEach(p => {
      messages.push(p.innerText);
    });
    alert("Summarize clicked. Messages collected: " + messages.length);
  });

  join();
}

function join() {
  const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
  let ws = new WebSocket(
    wss + hostname + "/api/room/" + roomname + "/websocket"
  );

  ws.addEventListener("open", () => {
    currentWebSocket = ws;
    ws.send(JSON.stringify({ name: username }));
  });

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);
    if (data.message) {
      addChatMessage(data.name, data.message);
    }
  });
}

function addChatMessage(name, text) {
  let p = document.createElement("p");
  if (name) {
    let tag = document.createElement("span");
    tag.className = "username";
    tag.innerText = name + ": ";
    p.appendChild(tag);
  }
  p.appendChild(document.createTextNode(text));
  chatlog.appendChild(p);
  chatlog.scrollBy(0, 1e8);
}

startNameChooser();
</script>
</html>
